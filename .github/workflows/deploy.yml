name: Deploy

on:
  push:
    branches: [dev, main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DJANGO_SETTINGS_MODULE: config.settings.prod

    steps:
      # 1) Checkout the code so that github.ref is set
      - name: Checkout code
        uses: actions/checkout@v3

      # 2) Set up Python 3.13 for sentry-cli
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      # 3) Install Sentry CLI
      - name: Install Sentry CLI
        run: |
          python -m pip install --upgrade pip
          pip install sentry-cli

      # 4) Create Sentry Release
      - name: Create Sentry Release
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG:       ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT:   ${{ secrets.SENTRY_PROJECT }}
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          sentry-cli releases new localstorymap@${COMMIT_SHA}
          sentry-cli releases set-commits --auto localstorymap@${COMMIT_SHA}
          sentry-cli releases finalize localstorymap@${COMMIT_SHA}

      # 5) SSH to server and run deploy script
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 223.130.152.69
          username: root
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            # prod í™˜ê²½ ì„¤ì • ê°•ì œ ì£¼ì…
            export DJANGO_SETTINGS_MODULE=config.settings.prod
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # â”€â”€â”€ 2-a) ë¸Œëœì¹˜ ì¶”ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            REF="${{ github.ref }}"
            BRANCH="${REF#refs/heads/}"
            echo "âœ… ë°°í¬ ë¸Œëœì¹˜: origin/$BRANCH"

            # â”€â”€â”€ 2-b) í”„ë¡œì íŠ¸ ë™ê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            cd /root/Oz_Backand/LocalStoryMap
            git fetch --all
            git reset --hard origin/$BRANCH
            echo "âœ… Git ë™ê¸°í™” ì™„ë£Œ"

            # â”€â”€â”€ 2-c) venv ì „ìš© Poetry ì„¤ì¹˜ & ê²½ë¡œ ì§€ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            VENV_BIN="/root/.cache/pypoetry/virtualenvs/localstorymap-JxpcprW_-py3.13/bin"
            "$VENV_BIN/python" -m pip install --upgrade poetry
            echo "ğŸ“¦ Poetry (venv) ë²„ì „: $($VENV_BIN/poetry --version)"

            # â”€â”€â”€ 2-d) ì˜ì¡´ì„± ì„¤ì¹˜ Â· ë§ˆì´ê·¸ë ˆì´ì…˜ Â· ì •ì  íŒŒì¼ ìˆ˜ì§‘ â”€
            "$VENV_BIN/poetry" install --no-interaction --no-root
            "$VENV_BIN/poetry" run python manage.py migrate --noinput --settings=config.settings.prod
            "$VENV_BIN/poetry" run python manage.py collectstatic --noinput --settings=config.settings.prod
            echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ì •ì  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ"

            # â”€â”€â”€ 2-e) systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸš€ systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘: localstorymap"
            sudo systemctl daemon-reload
            sudo systemctl restart localstorymap

            # â”€â”€â”€ 2-f) ë°°í¬ ì„±ê³µ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            sleep 5
            if systemctl is-active --quiet localstorymap; then
              echo "ğŸ‰ ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ ì¤‘."
              exit 0
            else
              echo "âŒ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹¤íŒ¨! ìµœê·¼ ë¡œê·¸:"
              sudo journalctl -u localstorymap -n 50
              exit 1
            fi