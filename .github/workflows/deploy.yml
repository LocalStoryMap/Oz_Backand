name: Deploy

on:
  push:
    branches: [dev, main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 223.130.152.69
          username: root
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # 1) í”„ë¡œì íŠ¸ í´ë” ì´ë™
            cd /root/Oz_Backand

            # 2) í˜„ì¬ ë¸Œëœì¹˜ ê°•ì œ ë™ê¸°í™”
            branch=${GITHUB_REF##*/}
            echo "[DEBUG] Syncing branch '$branch' with origin"
            git fetch --all
            git reset --hard origin/$branch

            # 3) ì•± ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            if [ -d "LocalStoryMap" ]; then
              cd LocalStoryMap
            fi

            # 4) Poetry í™˜ê²½ ì„¤ì •
            export PATH="/root/.local/bin:$PATH"
            poetry env use python3.13 || true

            # 5) ì˜ì¡´ì„± ì„¤ì¹˜
            poetry install --no-interaction --no-ansi --no-root

            # 6) .env íŒŒì¼ ì‘ì„±
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" > .env
            echo "DEBUG=False"                       >> .env
            echo "ALLOWED_HOSTS=223.130.152.69,localhost,127.0.0.1" >> .env

            # 7) ì´ì „ runserver ì¢…ë£Œ (PID íŒŒì¼ ë°©ì‹)
            if [ -f /root/runserver.pid ]; then
              oldpid=$(cat /root/runserver.pid) || true
              echo "ğŸ”ª Killing old runserver pid=$oldpid"
              kill "$oldpid" 2>/dev/null || true
              rm /root/runserver.pid
            fi

            # 8) ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ + PID íŒŒì¼ ê¸°ë¡)
            nohup poetry run python manage.py runserver 0.0.0.0:8000 \
              > /root/server.log 2>&1 &
            echo $! > /root/runserver.pid
            echo "ğŸš€ Started runserver with PID=$(cat /root/runserver.pid)"

            # 9) ë°°í¬ ì„±ê³µ í™•ì¸
            sleep 5
            if kill -0 "$(cat /root/runserver.pid)" 2>/dev/null; then
              echo "âœ… ë°°í¬ ì„±ê³µ! http://223.130.152.69:8000"
            else
              echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
              tail -n 50 /root/server.log
              exit 1
            fi
