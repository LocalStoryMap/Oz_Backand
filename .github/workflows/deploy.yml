name: Deploy

on:
  push:
    branches: [dev, main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1) ì½”ë“œ ì²´í¬ì•„ì›ƒ â€” GITHUB_REF í™˜ê²½ ë³€ìˆ˜ê°€ ì—¬ê¸°ì„œ ì„¤ì •ë©ë‹ˆë‹¤
      - name: Checkout code
        uses: actions/checkout@v3

      # 2) SSHë¡œ ì„œë²„ì— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 223.130.152.69
          username: root
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # â† ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤!
            # GITHUB_REFëŠ” "refs/heads/dev" ê°™ì€ ê°’ì´ ë“¤ì–´ìˆê³ ,
            # ì•„ë˜ë¡œ "dev" ë˜ëŠ” "main" ë§Œ ë½‘ì•„ëƒ…ë‹ˆë‹¤.
            BRANCH=${GITHUB_REF#refs/heads/}
            echo "âœ… ë°°í¬ ë¸Œëœì¹˜: origin/$BRANCH"

            # 3) í”„ë¡œì íŠ¸ ë™ê¸°í™”
            cd /root/Oz_Backand/LocalStoryMap
            git fetch --all
            git reset --hard origin/$BRANCH
            echo "âœ… Git ë™ê¸°í™” ì™„ë£Œ"

            # 4) ì˜ì¡´ì„±, ë§ˆì´ê·¸ë ˆì´ì…˜, static
            export PATH="/root/.cache/pypoetry/virtualenvs/localstorymap-JxpcprW_-py3.13/bin:$PATH"
            poetry install --no-interaction --no-root
            poetry run python manage.py migrate --noinput --settings=config.settings.prod
            poetry run python manage.py collectstatic --noinput --settings=config.settings.prod
            echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ì •ì  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ"

            # 5) systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "ğŸš€ systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘: localstorymap"
            sudo systemctl daemon-reload
            sudo systemctl restart localstorymap

            # 6) ë°°í¬ ì„±ê³µ í™•ì¸
            sleep 5
            if systemctl is-active --quiet localstorymap; then
              echo "ğŸ‰ ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ ì¤‘."
              exit 0
            else
              echo "âŒ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹¤íŒ¨! ìµœê·¼ ë¡œê·¸:"
              sudo journalctl -u localstorymap -n 50
              exit 1
            fi